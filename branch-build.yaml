pr:
  branches:
    exclude:
      - main
  paths:
    include:
      - /*

pool:
  name: 'selfhosted'

variables:
  serviceConnection: 'id-sub'
  location: 'swedencentral'
  csmParametersFile: './main.bicepparam'


jobs:
- job:
  displayName: 'branch build'
  steps:
    - script: |
        file_array=$(find . -type f -name "*.bicep" -or -name "*.bicepparam")
        for file in $file_array
        do
          echo "Linting $file"
          az bicep lint -f $file
        done
      displayName: 'lint'
    - task: AzureResourceManagerTemplateDeployment@3
      inputs:
          deploymentScope: 'managementGroup'
          azureResourceManagerConnection: ${{ variables.serviceConnection }}
          location: ${{ variables.location }}
          csmParametersFile: ${{ variables.csmParametersFile }}
          deploymentName: 'validation'
