pr:
  branches:
    exclude:
      - main
  paths:
    include:
      - /*

pool:
  name: 'selfhosted'

variables:
  azureServiceConnection: 'id-sub'
  location: 'swedencentral'
  csmParametersFile: './main.bicepparam'


jobs:
- job:
  displayName: 'branch build'
  steps:
    - script: |
        file_array=$(find . -type f -name "*.bicep" -or -name "*.bicepparam")
        for file in $file_array
        do
          echo "Linting $file"
          az bicep lint -f $file
        done
      displayName: 'lint'

    - task: AzureResourceManagerTemplateDeployment@3
      inputs:
        deploymentScope: 'Management Group'
        ConnectedServiceName: ${{ variables.azureServiceConnection }}
        location: ${{ variables.location }}
        deploymentMode: Validation
        csmParametersFile: ${{ variables.csmParametersFile }} 
      displayName: 'Preflight validation'

