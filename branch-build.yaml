pr:
  branches:
    exclude:
      - main
  paths:
    include:
      - /*

pool:
  name: 'selfhosted'

variables:
  azureServiceConnection: 'id-sub'
  location: 'swedencentral'
  csmParametersFile: './main.bicepparam'
  rootMgmId: 'tuttu-root'


jobs:
- job:
  displayName: 'branch build'
  steps:
    - script: |
        file_array=$(find . -type f -name "*.bicep" -or -name "*.bicepparam")
        for file in $file_array
        do
          echo "Linting $file"
          az bicep lint -f $file
        done
      displayName: 'lint'

    - task: AzureCLI@2
      displayName: What-if
      inputs:
        azureSubscription: ${{ parameters.azureServiceConnection }}
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          az deployment mg what-if --management-group-id '7d8e621a-3561-4cc4-9ee6-f03bc8610835' --parameters ./main.bicepparam -l swedencentral

    # - task: AzureResourceManagerTemplateDeployment@3
    #   inputs:
    #     deploymentScope: 'Management Group'
    #     ConnectedServiceName: ${{ variables.azureServiceConnection }}
    #     location: ${{ variables.location }}
    #     deploymentMode: Validation
    #     csmParametersFile: ${{ variables.csmParametersFile }} 
    #     ManagementGroupId: ${{ variables.rootMgmId }}
    #   displayName: 'Preflight validation'

